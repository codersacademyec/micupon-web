{"version":3,"sources":["indexService.js","indexCtrl.js"],"names":["indexService","globalService","socialProvider","login","i","Stamplay","User","socialLogin","getItems","filter","user","Object","get","then","res","data","cupones","usuario","response","length","cuponesEnviados","cupon","flag","j","k","codigos","console","log","_id","push","err","updateItem","item","patch","deleteItem","remove","saveItem","codeId","update","notificaciones","save","sendPush","perfil","push_token","addAlert","service","busqueda","modificar","eliminar","nuevo","indexCtrl","$scope","$rootScope","AccountService","$modal","vm","this","showFiltros","showNuevo","filtros","itemSeleccionado","currentUser","owner","buscar","modalEliminar","scope","template","html","show","animation","tableConfig","itemsPerPage","fillLastPage","ingresar","ocultarSide","$apply","$promise","confirmarElim","hide","guardar","$","modal","limpiarFiltros","angular","module","factory","controller"],"mappings":"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","file":"../index.js","sourcesContent":["angular.module('micupon').factory('indexService', ['globalService','socialProvider',indexService]);\r\n\r\nfunction indexService(globalService,socialProvider) {\r\n    var service = {\r\n        busqueda: getItems,\r\n        modificar: updateItem,\r\n        eliminar: deleteItem,\r\n        nuevo: saveItem,\r\n        login: login\r\n    };\r\n\r\n    return service;\r\n    function login(i){\r\n        Stamplay.User.socialLogin(socialProvider[i]);    \r\n    }\r\n    \r\n    function getItems(filter, user) {  //TODO VER PORQUE CONSULTA PRIMERO Y LUEGO VERIFICA SI EL USER ESTÁ LOGUEADO - HACE QUE NUNCA LLEGUE EL USER Y SE PUEDAN DESHABILITAR LOS CUPONES ENVIADOS\r\n        \r\n        /*var codeblock = new Stamplay.Codeblock(\"cuponespersonas\");\r\n        var data = {user : user, filtro: filter};\r\n\r\n        codeblock.run(data, {}, function (err, response) {\r\n            if(response.length > 0){\r\n                console.log(response);\r\n                return response;\r\n            }else if (err != null) {                        \r\n                console.log(err);\r\n                return null;\r\n            }\r\n        });*/\r\n\r\n        return Stamplay.Object(\"cupones\").get(filter)\r\n        .then(function(res) {\r\n                if(res.data){\r\n                    cupones = [];\r\n                    //if(user){ // si hay usuario logueado\r\n                        Stamplay.Object(\"cupones_usuarios\").get({usuario:'580a08882be61c073254b8d6'}) // buscamos los codigos que tiene enviados el usuario\r\n                        .then(function(response) {\r\n                            if(response.data.length > 0){\r\n                                var cuponesEnviados = response.data;\r\n                                for (var i = res.data.length - 1; i >= 0; i--) {\r\n                                    var cupon = res.data[i]; // tomamos el cupon\r\n                                    cupon.flag = false; // seteamos que sea editable\r\n\r\n                                    for (var j = cuponesEnviados.length - 1; j >= 0; j--) {\r\n                                       for (var k = cuponesEnviados[j].codigos.length - 1; k >= 0; k--) {\r\n                                            console.log(cupon._id);\r\n                                            console.log(cuponesEnviados[j].codigos[k]);\r\n                                            console.log(cupon._id == cuponesEnviados[j].codigos[k]);\r\n                                           if(cupon._id == cuponesEnviados[j].codigos[k]){ // si alguno de los codigos que vienen ya fue enviado para el usuario, lo deshabilitamos\r\n                                            cupon.flag = true; // seteamos que no sea editable porque ya se envió este cupon\r\n                                        }\r\n                                       }                                       \r\n                                    }\r\n                                    cupones.push(cupon); // agregamos el cupon modificado\r\n                                }\r\n                                return cupones;\r\n                            }                  \r\n                        }, function(err) {\r\n                            console.log(err);\r\n                        })\r\n                    //}                    \r\n                }\r\n                return res.data;\r\n\r\n            }, function(err) {\r\n              console.log(err);\r\n        });\r\n    }\r\n\r\n    function updateItem(item){\r\n       Stamplay.Object(\"cupones\").patch(\"codigo\",item)\r\n        .then(function(res) {\r\n          // success\r\n        }, function(err) {\r\n            console.log(err);\r\n        }) \r\n    }\r\n\r\n    function deleteItem(item){\r\n       Stamplay.Object(\"cupones\").remove(\"codigo\")\r\n        .then(function(response) {\r\n            // success\r\n        }, function(err) {\r\n           console.log(err);\r\n        }) \r\n    }\r\n\r\n    function saveItem(codeId, user){\r\n        Stamplay.Object(\"cupones_usuarios\").get({usuario:[user._id]}) // buscamos codigos enviados del usuario\r\n        .then(function(response) {\r\n            if(response.data && response.data.length > 0){ // si hay registro para el usuario\r\n                response.data[0].codigos.push(codeId); // agregamos uno más a la lista de codigos\r\n                console.log(response.data[0].codigos);\r\n                Stamplay.Object(\"cupones_usuarios\").update([user._id],usuario) // actualizamos los codigos enviados del usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                   console.log(err);\r\n                }) \r\n            }else{\r\n                var data = {usuario:[user._id], codigos:[codeId]};\r\n                Stamplay.Object(\"cupones_usuarios\").save(data) // creamos un registro para el usuario en cupones_usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                    console.log(err);\r\n                }) \r\n            }\r\n        }, function(err) {\r\n            console.log(err);\r\n        })      \r\n    }\r\n\r\n    function notificaciones(user){\r\n        globalService.sendPush(user.perfil.push_token,'El cupón ha sido enviado a su movil.'); // enviamos la notificación push\r\n        addAlert(); // mostramos mensaje en pantalla\r\n    }\r\n    \r\n}","angular.module('micupon').controller('indexCtrl', ['$scope', '$rootScope', 'globalService', 'indexService', 'AccountService', '$modal', indexCtrl]);\r\n\r\nfunction indexCtrl($scope, $rootScope, globalService, indexService, AccountService, $modal) {\r\n    var vm = this;\r\n    vm.globalService = globalService;\r\n    vm.cupones = [];\r\n    vm.showFiltros = false;\r\n    vm.showNuevo = false;\r\n    vm.filtros = {};\r\n    vm.nuevo = {};\r\n    vm.itemSeleccionado = {};\r\n \r\n\r\n    AccountService.currentUser()\r\n        .then(function(user) {\r\n            if (user || $rootScope.user) {\r\n                $rootScope.user = user ? user : $rootScope.user;\r\n                Stamplay.Object(\"usuarios\").get({owner: $rootScope.user._id})\r\n                    .then(function(res) {\r\n                        $rootScope.user.perfil = res.data[0];\r\n                    }, function(err) {\r\n                        console.log(err);\r\n                    })\r\n            }\r\n\t\t\tvm.buscar();       \r\n        });\r\n\r\n    vm.modalEliminar = $modal({\r\n        scope: $scope,\r\n        template: '<div class=\"modal\"><div class=\"modal-dialog\" role=\"document\"><div class=\"modal-content\"><div class=\"modal-header\"><h4 class=\"modal-title\">Eliminar la banda horaria con id {{ctrl.bandaSeleccionada.id}}?</h4></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" ng-click=\"$hide()\">Cancelar</button><button type=\"button\" class=\"btn btn-danger\" ng-click=\"ctrl.confirmarElim()\">Eliminar</button></div></div></div></div>',\r\n        html: true,\r\n        show: false,\r\n        animation: 'am-slide-top'\r\n    });\r\n\r\n    vm.tableConfig = {\r\n        itemsPerPage: 5,\r\n        fillLastPage: true\r\n    };\r\n\r\n    vm.ingresar = function(i) {\r\n        indexService.login(i);\r\n    };\r\n\r\n    vm.ocultarSide = function() {\r\n        vm.showFiltros = false;\r\n        vm.showNuevo = false;\r\n    };\r\n\r\n    vm.buscar = function() {\r\n        indexService.busqueda(vm.filtros, $rootScope.user).then(function(data) {\r\n            vm.cupones = data;\r\n            vm.showFiltros = false;\r\n            $scope.$apply();\r\n        });\r\n    };\r\n\r\n    vm.eliminar = function(item) {\r\n        vm.itemSeleccionado = item;\r\n        vm.modalEliminar.$promise.then(vm.modalEliminar.show);\r\n    };\r\n\r\n    vm.confirmarElim = function() {\r\n        indexService.eliminar(vm.itemSeleccionado).then(function(data) {\r\n            vm.modalEliminar.$promise.then(vm.modalEliminar.hide);\r\n        });\r\n    };\r\n\r\n    vm.guardar = function(item) {\r\n        if(!$rootScope.user){\r\n            $('#login-dialog').modal();\r\n        }\r\n        else{\r\n            indexService.nuevo(item,$rootScope.user);\r\n        }\r\n    };\r\n\r\n    vm.limpiarFiltros = function() {\r\n        vm.filtros = {};\r\n    };\r\n    \r\n}"]}