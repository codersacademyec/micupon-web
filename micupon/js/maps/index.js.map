{"version":3,"sources":["indexService.js","indexCtrl.js"],"names":["indexService","globalService","socialProvider","login","i","Stamplay","User","socialLogin","getItems","filter","user","Object","get","then","res","data","cupones","usuario","perfil","id","response","length","cuponesEnviados","cupon","flag","j","k","codigos","_id","push","err","console","log","updateItem","item","patch","deleteItem","remove","saveItem","codeId","update","notificaciones","save","sendPush","push_token","addAlert","service","busqueda","modificar","eliminar","nuevo","indexCtrl","$scope","$rootScope","AccountService","$modal","vm","this","showFiltros","showNuevo","filtros","itemSeleccionado","currentUser","owner","buscar","modalEliminar","scope","template","html","show","animation","tableConfig","itemsPerPage","fillLastPage","ingresar","ocultarSide","$apply","$promise","confirmarElim","hide","guardar","$","modal","limpiarFiltros","angular","module","factory","controller"],"mappings":"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","file":"../index.js","sourcesContent":["angular.module('micupon').factory('indexService', ['globalService','socialProvider',indexService]);\r\n\r\nfunction indexService(globalService,socialProvider) {\r\n    var service = {\r\n        busqueda: getItems,\r\n        modificar: updateItem,\r\n        eliminar: deleteItem,\r\n        nuevo: saveItem,\r\n        login: login\r\n    };\r\n\r\n    return service;\r\n    function login(i){\r\n        Stamplay.User.socialLogin(socialProvider[i]);    \r\n    }\r\n    \r\n    function getItems(filter, user) { \r\n        /*var codeblock = new Stamplay.Codeblock(\"cuponespersonas\");\r\n        var data = {user : user, filtro: filter};\r\n\r\n        codeblock.run(data, {}, function (err, response) {\r\n            if(response.length > 0){\r\n                console.log(response);\r\n                return response;\r\n            }else if (err != null) {                        \r\n                console.log(err);\r\n                return null;\r\n            }\r\n        });*/\r\n\r\n        return Stamplay.Object(\"cupones\").get(filter)\r\n        .then(function(res) {\r\n                if(res.data){\r\n                    cupones = [];\r\n                    if(user){ // si hay usuario logueado\r\n                        Stamplay.Object(\"cupones_usuarios\").get({usuario:user.perfil.id}) // buscamos los codigos que tiene enviados el usuario\r\n                        .then(function(response) {\r\n                            if(response.data.length > 0){\r\n                                var cuponesEnviados = response.data;\r\n                                for (var i = res.data.length - 1; i >= 0; i--) {\r\n                                    var cupon = res.data[i]; // tomamos el cupon\r\n                                    cupon.flag = false; // seteamos que sea editable\r\n\r\n                                    for (var j = cuponesEnviados.length - 1; j >= 0; j--) {\r\n                                       for (var k = cuponesEnviados[j].codigos.length - 1; k >= 0; k--) {\r\n                                           if(cupon._id == cuponesEnviados[j].codigos[k]){ // si alguno de los codigos que vienen ya fue enviado para el usuario, lo deshabilitamos\r\n                                            cupon.flag = true; // seteamos que no sea editable porque ya se envi칩 este cupon\r\n                                        }\r\n                                       }                                       \r\n                                    }\r\n                                    cupones.push(cupon); // agregamos el cupon modificado\r\n                                }\r\n                                return cupones;\r\n                            }                  \r\n                        }, function(err) {\r\n                            console.log(err);\r\n                        })\r\n                    }                    \r\n                }\r\n                return res.data;                \r\n\r\n            }, function(err) {\r\n              console.log(err);\r\n        });\r\n    }\r\n\r\n    function updateItem(item){\r\n       Stamplay.Object(\"cupones\").patch(\"codigo\",item)\r\n        .then(function(res) {\r\n          // success\r\n        }, function(err) {\r\n            console.log(err);\r\n        }) \r\n    }\r\n\r\n    function deleteItem(item){\r\n       Stamplay.Object(\"cupones\").remove(\"codigo\")\r\n        .then(function(response) {\r\n            // success\r\n        }, function(err) {\r\n           console.log(err);\r\n        }) \r\n    }\r\n\r\n    function saveItem(codeId, user){\r\n        Stamplay.Object(\"cupones_usuarios\").get({usuario:user.perfil.id}) // buscamos codigos enviados del usuario\r\n        .then(function(response) {\r\n            if(response.data && response.data.length > 0){ // si hay registro para el usuario\r\n                response.data[0].codigos.push(codeId); // agregamos uno m치s a la lista de codigos\r\n                console.log(response.data[0].codigos);\r\n                Stamplay.Object(\"cupones_usuarios\").update(response.data[0].id,response.data[0]) // actualizamos los codigos enviados del usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                   console.log(err);\r\n                }) \r\n            }else{\r\n                var data = {usuario:[user.perfil.id], codigos:[codeId]};\r\n                Stamplay.Object(\"cupones_usuarios\").save(data) // creamos un registro para el usuario en cupones_usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                    console.log(err);\r\n                }) \r\n            }\r\n        }, function(err) {\r\n            console.log(err);\r\n        })      \r\n    }\r\n\r\n    function notificaciones(user){\r\n        globalService.sendPush(user.perfil.push_token,'El cup칩n ha sido enviado a su movil.'); // enviamos la notificaci칩n push\r\n        addAlert(); // mostramos mensaje en pantalla\r\n    }\r\n    \r\n}","angular.module('micupon').controller('indexCtrl', ['$scope', '$rootScope', 'globalService', 'indexService', 'AccountService', '$modal', indexCtrl]);\r\n\r\nfunction indexCtrl($scope, $rootScope, globalService, indexService, AccountService, $modal) {\r\n    var vm = this;\r\n    vm.globalService = globalService;\r\n    vm.cupones = [];\r\n    vm.showFiltros = false;\r\n    vm.showNuevo = false;\r\n    vm.filtros = {};\r\n    vm.nuevo = {};\r\n    vm.itemSeleccionado = {};\r\n \r\n\r\n    AccountService.currentUser()\r\n        .then(function(user) {\r\n            if (user || $rootScope.user) {\r\n                $rootScope.user = user ? user : $rootScope.user;\r\n                Stamplay.Object(\"usuarios\").get({owner: $rootScope.user._id})\r\n                    .then(function(res) {\r\n                        $rootScope.user.perfil = res.data[0];\r\n                    }, function(err) {\r\n                        console.log(err);\r\n                    })\r\n            }\r\n\t\t\tvm.buscar();\r\n        });\r\n\r\n    vm.modalEliminar = $modal({\r\n        scope: $scope,\r\n        template: '<div class=\"modal\"><div class=\"modal-dialog\" role=\"document\"><div class=\"modal-content\"><div class=\"modal-header\"><h4 class=\"modal-title\">Eliminar la banda horaria con id {{ctrl.bandaSeleccionada.id}}?</h4></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" ng-click=\"$hide()\">Cancelar</button><button type=\"button\" class=\"btn btn-danger\" ng-click=\"ctrl.confirmarElim()\">Eliminar</button></div></div></div></div>',\r\n        html: true,\r\n        show: false,\r\n        animation: 'am-slide-top'\r\n    });\r\n\r\n    vm.tableConfig = {\r\n        itemsPerPage: 5,\r\n        fillLastPage: true\r\n    };\r\n\r\n    vm.ingresar = function(i) {\r\n        indexService.login(i);\r\n    };\r\n\r\n    vm.ocultarSide = function() {\r\n        vm.showFiltros = false;\r\n        vm.showNuevo = false;\r\n    };\r\n\r\n    vm.buscar = function() {\r\n        indexService.busqueda(vm.filtros, $rootScope.user).then(function(data) {\r\n            vm.cupones = data;\r\n            vm.showFiltros = false;\r\n            $scope.$apply();\r\n        });\r\n    };\r\n\r\n    vm.eliminar = function(item) {\r\n        vm.itemSeleccionado = item;\r\n        vm.modalEliminar.$promise.then(vm.modalEliminar.show);\r\n    };\r\n\r\n    vm.confirmarElim = function() {\r\n        indexService.eliminar(vm.itemSeleccionado).then(function(data) {\r\n            vm.modalEliminar.$promise.then(vm.modalEliminar.hide);\r\n        });\r\n    };\r\n\r\n    vm.guardar = function(item) {\r\n        if(!$rootScope.user){\r\n            $('#login-dialog').modal();\r\n        }\r\n        else{\r\n            indexService.nuevo(item,$rootScope.user);\r\n            vm.buscar();\r\n        }\r\n    };\r\n\r\n    vm.limpiarFiltros = function() {\r\n        vm.filtros = {};\r\n    };\r\n    \r\n}"]}