{"version":3,"sources":["indexService.js","indexCtrl.js"],"names":["indexService","globalService","socialProvider","login","i","Stamplay","User","socialLogin","getItems","filtro","user","Object","get","then","res","data","cupones","length","cupon","flag","usuario","_id","response","j","k","codigos","err","push","updateItem","item","patch","deleteItem","remove","saveItem","codeId","sendPush","perfil","push_token","addAlert","save","service","busqueda","modificar","eliminar","nuevo","indexCtrl","$scope","$rootScope","AccountService","$modal","vm","this","showFiltros","showNuevo","filtros","itemSeleccionado","modalEliminar","scope","template","html","show","animation","tableConfig","itemsPerPage","fillLastPage","currentUser","owner","ingresar","ocultarSide","buscar","$apply","$promise","confirmarElim","hide","guardar","$","modal","limpiarFiltros","angular","module","factory","controller"],"mappings":"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","file":"../index.js","sourcesContent":["angular.module('micupon').factory('indexService', ['globalService','socialProvider',indexService]);\r\n\r\nfunction indexService(globalService,socialProvider) {\r\n    var service = {\r\n        busqueda: getItems,\r\n        modificar: updateItem,\r\n        eliminar: deleteItem,\r\n        nuevo: saveItem,\r\n        login: login\r\n    };\r\n\r\n    return service;\r\n    function login(i){\r\n        Stamplay.User.socialLogin(socialProvider[i]);    \r\n    }\r\n    \r\n    function getItems(filtro, user) {  //TODO VER PORQUE CONSULTA PRIMERO Y LUEGO VERIFICA SI EL USER ESTÁ LOGUEADO - HACE QUE NUNCA LLEGUE EL USER Y SE PUEDAN DESHABILITAR LOS CUPONES ENVIADOS\r\n        return Stamplay.Object(\"cupones\").get(filtro)\r\n        .then(function(res) {\r\n                if(res.data){\r\n                    cupones = [];                    \r\n                    for (var i = res.data.length - 1; i >= 0; i--) {\r\n                        cupon = res.data[i]; // tomamos el cupon\r\n                        cupon.flag = false; // seteamos que sea editable\r\n                        if(user){ // si hay usuario logueado\r\n                            Stamplay.Object(\"cupones_usuarios\").get({usuario:user._id}) // buscamos los codigos que tiene enviados el usuario\r\n                            .then(function(response) {\r\n                                if(response){\r\n                                    for (var j = response.data.length - 1; j >= 0; j--) {\r\n                                       for (var k = response.data[j].codigos.length - 1; k >= 0; k--) {\r\n                                           if(cupon._id == response.data[j].codigos[k]){ // si alguno de los codigos que vienen ya fue enviado para el usuario, lo deshabilitamos\r\n                                            cupon.flag = true; // seteamos que no sea editable porque ya se envió este cupon\r\n                                        }\r\n                                       }                                       \r\n                                    } \r\n                                }                          \r\n                            }, function(err) {\r\n                                // TODO MOSTRAR ERROR\r\n                            })\r\n                        } \r\n                        cupones.push(cupon); // agregamos el cupon modificado\r\n                    }\r\n                }\r\n                res.data = cupones; // pisamos los cupones\r\n                return res.data;    \r\n            }, function(err) {\r\n                // TODO MOSTRAR ERROR\r\n        });\r\n    }\r\n\r\n    function updateItem(item){\r\n       Stamplay.Object(\"cupones\").patch(\"codigo\",item)\r\n        .then(function(res) {\r\n          // success\r\n        }, function(err) {\r\n          // error\r\n        }) \r\n    }\r\n\r\n    function deleteItem(item){\r\n       Stamplay.Object(\"cupones\").remove(\"codigo\")\r\n        .then(function(response) {\r\n            // success\r\n        }, function(err) {\r\n          // error\r\n        }) \r\n    }\r\n\r\n    function saveItem(codeId, user){\r\n        Stamplay.Object(\"cupones_usuarios\").get({usuario:user._id}) // buscamos codigos enviados del usuario\r\n        .then(function(response) {\r\n            if(response && response.length > 0){ // si hay registro para el usuario\r\n                response.codigos.push(codeId); // agregamos uno más a la lista de codigos\r\n                Stamplay.Object(\"cupones_usuarios\").patch({usuario:user._id,codigos:response.codigos}) // actualizamos los codigos enviados del usuario\r\n                .then(function(res) {\r\n                    globalService.sendPush(user.perfil.push_token,'El cupón ha sido enviado a su movil.'); // enviamos la notificación push\r\n                    addAlert(); // mostramos mensaje en pantalla\r\n                }, function(err) {\r\n                    // TODO MOSTRAR ERROR\r\n                }) \r\n            }else{\r\n                Stamplay.Object(\"cupones_usuarios\").save({usuario:user._id, codigos:codeId}) // creamos un registro para el usuario en cupones_usuario\r\n                .then(function(res) {\r\n                    globalService.sendPush(user.perfil.push_token,'El cupón ha sido enviado a su movil.'); // enviamos la notificación push\r\n                    addAlert(); // mostramos mensaje en pantalla\r\n                }, function(err) {\r\n                    // TODO MOSTRAR ERROR\r\n                }) \r\n            }\r\n        }, function(err) {\r\n            // TODO MOSTRAR ERROR\r\n            \r\n        })      \r\n    }\r\n\r\n    \r\n}","angular.module('micupon').controller('indexCtrl', ['$scope', '$rootScope', 'globalService', 'indexService', 'AccountService', '$modal', indexCtrl]);\r\n\r\nfunction indexCtrl($scope, $rootScope, globalService, indexService, AccountService, $modal) {\r\n    var vm = this;\r\n    vm.globalService = globalService;\r\n    vm.cupones = [];\r\n    vm.showFiltros = false;\r\n    vm.showNuevo = false;\r\n    vm.filtros = {};\r\n    vm.nuevo = {};\r\n    vm.itemSeleccionado = {};\r\n\r\n    vm.modalEliminar = $modal({\r\n        scope: $scope,\r\n        template: '<div class=\"modal\"><div class=\"modal-dialog\" role=\"document\"><div class=\"modal-content\"><div class=\"modal-header\"><h4 class=\"modal-title\">Eliminar la banda horaria con id {{ctrl.bandaSeleccionada.id}}?</h4></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" ng-click=\"$hide()\">Cancelar</button><button type=\"button\" class=\"btn btn-danger\" ng-click=\"ctrl.confirmarElim()\">Eliminar</button></div></div></div></div>',\r\n        html: true,\r\n        show: false,\r\n        animation: 'am-slide-top'\r\n    });\r\n\r\n    vm.tableConfig = {\r\n        itemsPerPage: 5,\r\n        fillLastPage: true\r\n    };\r\n\r\n    AccountService.currentUser()\r\n        .then(function(user) {\r\n            if (user || $rootScope.user) {\r\n                $rootScope.user = user ? user : $rootScope.user;\r\n                Stamplay.Object(\"usuarios\").get({\r\n                        owner: $rootScope.user._id\r\n                    })\r\n                    .then(function(res) {\r\n                        $rootScope.user.perfil = res.data[0];\r\n                    }, function(err) {\r\n                        // Error\r\n                    });\r\n            }\r\n        });\r\n\r\n    vm.ingresar = function(i) {\r\n        indexService.login(i);\r\n    };\r\n\r\n    vm.ocultarSide = function() {\r\n        vm.showFiltros = false;\r\n        vm.showNuevo = false;\r\n    };\r\n\r\n    vm.buscar = function() {\r\n        indexService.busqueda(vm.filtros, $rootScope.user).then(function(data) {\r\n            vm.cupones = data;\r\n            vm.showFiltros = false;\r\n            $scope.$apply();\r\n        });\r\n    };\r\n\r\n    vm.eliminar = function(item) {\r\n        vm.itemSeleccionado = item;\r\n        vm.modalEliminar.$promise.then(vm.modalEliminar.show);\r\n    };\r\n\r\n    vm.confirmarElim = function() {\r\n        indexService.eliminar(vm.itemSeleccionado).then(function(data) {\r\n            vm.modalEliminar.$promise.then(vm.modalEliminar.hide);\r\n        });\r\n    };\r\n\r\n    vm.guardar = function(item) {\r\n        if(!$rootScope.user){\r\n            $('#login-dialog').modal();\r\n        }\r\n        else{\r\n            indexService.nuevo(item,$rootScope.user);\r\n        }\r\n    };\r\n\r\n    vm.limpiarFiltros = function() {\r\n        vm.filtros = {};\r\n    };\r\n\r\n    vm.buscar();   \r\n    \r\n}"]}