{"version":3,"sources":["indexService.js","indexCtrl.js"],"names":["indexService","globalService","socialProvider","login","i","Stamplay","User","socialLogin","getItems","filter","user","data","_id","perfil","filtro","codeblock","Codeblock","run","then","response","err","console","error","updateItem","item","Object","patch","res","log","deleteItem","remove","saveItem","codeId","get","usuario","id","length","codigos","push","update","notificaciones","save","sendPush","push_token","addAlert","service","busqueda","modificar","eliminar","nuevo","indexCtrl","$scope","$rootScope","AccountService","$modal","vm","this","cupones","showFiltros","showNuevo","filtros","itemSeleccionado","currentUser","owner","buscar","modalEliminar","scope","template","html","show","animation","tableConfig","itemsPerPage","fillLastPage","ingresar","ocultarSide","$digest","$promise","confirmarElim","hide","guardar","$","modal","limpiarFiltros","angular","module","factory","controller"],"mappings":"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","file":"../index.js","sourcesContent":["angular.module('micupon').factory('indexService', ['globalService','socialProvider',indexService]);\n\nfunction indexService(globalService,socialProvider) {\n    var service = {\n        busqueda: getItems,\n        modificar: updateItem,\n        eliminar: deleteItem,\n        nuevo: saveItem,\n        login: login\n    };\n\n    return service;\n    function login(i){\n        Stamplay.User.socialLogin(socialProvider[i]);    \n    }\n    \n    function getItems(filter, user) { \n        var data = {user : { _id: user._id, perfil: user.perfil }, filtro: filter};\n        var codeblock = new Stamplay.Codeblock(\"cuponespersonas\");\n        return codeblock.run(data).then(function (response) {\n          return response;\n        }, function( err ){\n          console.error(err);\n          return null;\n        });\n    }\n\n    function updateItem(item){\n       Stamplay.Object(\"cupones\").patch(\"codigo\",item)\n        .then(function(res) {\n          // success\n        }, function(err) {\n            console.log(err);\n        }) \n    }\n\n    function deleteItem(item){\n       Stamplay.Object(\"cupones\").remove(\"codigo\")\n        .then(function(response) {\n            // success\n        }, function(err) {\n           console.log(err);\n        }) \n    }\n\n    function saveItem(codeId, user){\n        Stamplay.Object(\"cupones_usuarios\").get({usuario:user.perfil.id}) // buscamos codigos enviados del usuario\n        .then(function(response) {\n            if(response.data && response.data.length > 0){ // si hay registro para el usuario\n                response.data[0].codigos.push(codeId); // agregamos uno más a la lista de codigos\n                console.log(response.data[0].codigos);\n                Stamplay.Object(\"cupones_usuarios\").update(response.data[0].id,response.data[0]) // actualizamos los codigos enviados del usuario\n                .then(function(res) {\n                    notificaciones(user);\n                }, function(err) {\n                   console.log(err);\n                }) \n            }else{\n                var data = {usuario:[user.perfil.id], codigos:[codeId]};\n                Stamplay.Object(\"cupones_usuarios\").save(data) // creamos un registro para el usuario en cupones_usuario\n                .then(function(res) {\n                    notificaciones(user);\n                }, function(err) {\n                    console.log(err);\n                }) \n            }\n        }, function(err) {\n            console.log(err);\n        })      \n    }\n\n    function notificaciones(user){\n        globalService.sendPush(user.perfil.push_token,'El cupón ha sido enviado a su movil.'); // enviamos la notificación push\n        addAlert(); // mostramos mensaje en pantalla\n    }\n    \n}","angular.module('micupon').controller('indexCtrl', ['$scope', '$rootScope', 'globalService', 'indexService', 'AccountService', '$modal', indexCtrl]);\n\nfunction indexCtrl($scope, $rootScope, globalService, indexService, AccountService, $modal) {\n    var vm = this;\n    vm.globalService = globalService;\n    vm.cupones = [];\n    vm.showFiltros = false;\n    vm.showNuevo = false;\n    vm.filtros = {};\n    vm.nuevo = {};\n    vm.itemSeleccionado = {};\n \n    //$rootScope.user = {\"_id\":\"57feba3ca3b12b294d4891c0\",\"appId\":\"micupon\",\"displayName\":\"Gonzalo Aller\",\"name\":{\"familyName\":\"Aller\",\"givenName\":\"Gonzalo\"},\"pictures\":{\"google\":\"https://lh5.googleusercontent.com/-5HPa6h3FB88/AAAAAAAAAAI/AAAAAAAAB_4/i0qyKV7fxjg/photo.jpg\"},\"givenRole\":\"57eff5d03054317a6c37998b\",\"email\":\"gonzaller@gmail.com\",\"identities\":{\"google\":{\"googleUid\":\"108349644188900323702\",\"refreshToken\":\"1/LVl2DtrAwk_WpPTLe2m-gHY7Zz05Bqou9_shgoaBZwksHjrrZIvuhpe-_ZOYsf0j\",\"_json\":{\"locale\":\"es-419\",\"gender\":\"male\",\"picture\":\"https://lh5.googleusercontent.com/-5HPa6h3FB88/AAAAAAAAAAI/AAAAAAAAB_4/i0qyKV7fxjg/photo.jpg\",\"link\":\"https://plus.google.com/108349644188900323702\",\"family_name\":\"Aller\",\"given_name\":\"Gonzalo\",\"name\":\"Gonzalo Aller\",\"verified_email\":true,\"email\":\"gonzaller@gmail.com\",\"id\":\"108349644188900323702\"},\"emails\":[{\"value\":\"gonzaller@gmail.com\"}],\"accessToken\":\"ya29.Ci-JA59y1vCARcb5SrKPJsDEx94EHBgxNleqmSBX100uILEO0RGB_RP8LJ18CyxWKA\"}},\"__v\":0,\"dt_update\":\"2016-10-27T23:18:31.741Z\",\"dt_create\":\"2016-10-12T22:33:32.096Z\",\"emailVerified\":true,\"verificationCode\":\"f5f70b492d430bfc262f\",\"profileImg\":\"https://lh5.googleusercontent.com/-5HPa6h3FB88/AAAAAAAAAAI/AAAAAAAAB_4/i0qyKV7fxjg/photo.jpg\",\"id\":\"57feba3ca3b12b294d4891c0\",\"perfil\":{\"_id\":\"57fec0700d63f676601f24ac\",\"sexo\":\"male\",\"nombre\":\"Gonzalo\",\"email\":\"gonzaller@gmail.com\",\"apellido\":\"Aller\",\"owner\":\"57feba3ca3b12b294d4891c0\",\"appId\":\"micupon\",\"cobjectId\":\"usuarios\",\"actions\":{\"comments\":[],\"ratings\":{\"users\":[],\"avg\":0,\"total\":0},\"votes\":{\"users_downvote\":[],\"users_upvote\":[],\"users\":[],\"total\":0}},\"dt_update\":\"2016-10-18T00:44:53.929Z\",\"dt_create\":\"2016-10-12T23:00:00.844Z\",\"__v\":0,\"push_token\":\"62fd3d375167014fbc29a812704fb29a5bd6c0a4d791436dd56a5c7d209e4532\",\"id\":\"57fec0700d63f676601f24ac\"}};\n    AccountService.currentUser()\n        .then(function(user) {\n            if (user || $rootScope.user) {\n                $rootScope.user = user ? user : $rootScope.user;\n                Stamplay.Object(\"usuarios\").get({owner: $rootScope.user._id})\n                    .then(function(res) {\n                        $rootScope.user.perfil = res.data[0];\n                        vm.buscar();\n                    }, function(err) {\n                        console.log(err);\n                    });\n            }\n        });\n\n    vm.modalEliminar = $modal({\n        scope: $scope,\n        template: '<div class=\"modal\"><div class=\"modal-dialog\" role=\"document\"><div class=\"modal-content\"><div class=\"modal-header\"><h4 class=\"modal-title\">Eliminar la banda horaria con id {{ctrl.bandaSeleccionada.id}}?</h4></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" ng-click=\"$hide()\">Cancelar</button><button type=\"button\" class=\"btn btn-danger\" ng-click=\"ctrl.confirmarElim()\">Eliminar</button></div></div></div></div>',\n        html: true,\n        show: false,\n        animation: 'am-slide-top'\n    });\n\n    vm.tableConfig = {\n        itemsPerPage: 5,\n        fillLastPage: true\n    };\n\n    vm.ingresar = function(i) {\n        indexService.login(i);\n    };\n\n    vm.ocultarSide = function() {\n        vm.showFiltros = false;\n        vm.showNuevo = false;\n    };\n\n    vm.buscar = function() {\n        indexService.busqueda(vm.filtros, $rootScope.user).then(function(data) {\n            vm.cupones = data;\n            vm.showFiltros = false;\n            $scope.$digest();\n            console.log(data);\n        });\n    };\n\n    vm.eliminar = function(item) {\n        vm.itemSeleccionado = item;\n        vm.modalEliminar.$promise.then(vm.modalEliminar.show);\n    };\n\n    vm.confirmarElim = function() {\n        indexService.eliminar(vm.itemSeleccionado).then(function(data) {\n            vm.modalEliminar.$promise.then(vm.modalEliminar.hide);\n        });\n    };\n\n    vm.guardar = function(item) {\n        if(!$rootScope.user){\n            $('#login-dialog').modal();\n        }\n        else{\n            indexService.nuevo(item,$rootScope.user);\n            vm.buscar();\n        }\n    };\n\n    vm.limpiarFiltros = function() {\n        vm.filtros = {};\n    };\n    //vm.buscar();\n}"]}