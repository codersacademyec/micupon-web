{"version":3,"sources":["indexService.js","indexCtrl.js"],"names":["indexService","globalService","socialProvider","login","i","Stamplay","User","socialLogin","getItems","filter","user","data","filtro","_id","perfil","codeblock","Codeblock","run","then","response","err","console","error","updateItem","item","Object","patch","res","log","deleteItem","remove","saveItem","codeId","get","usuario","id","length","codigos","push","update","notificaciones","save","sendPush","push_token","addAlert","service","busqueda","modificar","eliminar","nuevo","indexCtrl","$scope","$rootScope","AccountService","$modal","vm","this","cupones","showFiltros","showNuevo","filtros","itemSeleccionado","currentUser","owner","buscar","modalEliminar","scope","template","html","show","animation","tableConfig","itemsPerPage","fillLastPage","ingresar","ocultarSide","$digest","$promise","confirmarElim","hide","guardar","flag","$","modal","limpiarFiltros","angular","module","factory","controller"],"mappings":"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","file":"../index.js","sourcesContent":["angular.module('micupon').factory('indexService', ['globalService','socialProvider',indexService]);\r\n\r\nfunction indexService(globalService,socialProvider) {\r\n    var service = {\r\n        busqueda: getItems,\r\n        modificar: updateItem,\r\n        eliminar: deleteItem,\r\n        nuevo: saveItem,\r\n        login: login\r\n    };\r\n\r\n    return service;\r\n    function login(i){\r\n        Stamplay.User.socialLogin(socialProvider[i]);    \r\n    }\r\n    \r\n    function getItems(filter, user) {\r\n        var data = {filtro: filter};\r\n        if(user){\r\n            data = {user : { _id: user._id, perfil: user.perfil }, filtro: filter};\r\n        }\r\n        var codeblock = new Stamplay.Codeblock(\"cuponespersonas\");\r\n        return codeblock.run(data).then(function (response) {\r\n          return response;\r\n        }, function( err ){\r\n          console.error(err);\r\n          return null;\r\n        });\r\n    }\r\n\r\n    function updateItem(item){\r\n       Stamplay.Object(\"cupones\").patch(\"codigo\",item)\r\n        .then(function(res) {\r\n          // success\r\n        }, function(err) {\r\n            console.log(err);\r\n        }) \r\n    }\r\n\r\n    function deleteItem(item){\r\n       Stamplay.Object(\"cupones\").remove(\"codigo\")\r\n        .then(function(response) {\r\n            // success\r\n        }, function(err) {\r\n           console.log(err);\r\n        }) \r\n    }\r\n\r\n    function saveItem(codeId, user){\r\n        Stamplay.Object(\"cupones_usuarios\").get({usuario:user.perfil.id}) // buscamos codigos enviados del usuario\r\n        .then(function(response) {\r\n            if(response.data && response.data.length > 0){ // si hay registro para el usuario\r\n                response.data[0].codigos.push(codeId); // agregamos uno más a la lista de codigos\r\n                console.log(response.data[0].codigos);\r\n                Stamplay.Object(\"cupones_usuarios\").update(response.data[0].id,response.data[0]) // actualizamos los codigos enviados del usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                   console.log(err);\r\n                }) \r\n            }else{\r\n                var data = {usuario:[user.perfil.id], codigos:[codeId]};\r\n                Stamplay.Object(\"cupones_usuarios\").save(data) // creamos un registro para el usuario en cupones_usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                    console.log(err);\r\n                }) \r\n            }\r\n        }, function(err) {\r\n            console.log(err);\r\n        })      \r\n    }\r\n\r\n    function notificaciones(user){\r\n        globalService.sendPush(user.perfil.push_token,'El cupón ha sido enviado a su movil.'); // enviamos la notificación push\r\n        addAlert(); // mostramos mensaje en pantalla\r\n    }\r\n    \r\n}","angular.module('micupon').controller('indexCtrl', ['$scope', '$rootScope', 'globalService', 'indexService', 'AccountService', '$modal', indexCtrl]);\r\n\r\nfunction indexCtrl($scope, $rootScope, globalService, indexService, AccountService, $modal) {\r\n    var vm = this;\r\n    vm.globalService = globalService;\r\n    vm.cupones = [];\r\n    vm.showFiltros = false;\r\n    vm.showNuevo = false;\r\n    vm.filtros = {};\r\n    vm.nuevo = {};\r\n    vm.itemSeleccionado = {};\r\n \r\n    //$rootScope.user = {\"_id\":\"57feba3ca3b12b294d4891c0\",\"appId\":\"micupon\",\"displayName\":\"Gonzalo Aller\",\"name\":{\"familyName\":\"Aller\",\"givenName\":\"Gonzalo\"},\"pictures\":{\"google\":\"https://lh5.googleusercontent.com/-5HPa6h3FB88/AAAAAAAAAAI/AAAAAAAAB_4/i0qyKV7fxjg/photo.jpg\"},\"givenRole\":\"57eff5d03054317a6c37998b\",\"email\":\"gonzaller@gmail.com\",\"identities\":{\"google\":{\"googleUid\":\"108349644188900323702\",\"refreshToken\":\"1/LVl2DtrAwk_WpPTLe2m-gHY7Zz05Bqou9_shgoaBZwksHjrrZIvuhpe-_ZOYsf0j\",\"_json\":{\"locale\":\"es-419\",\"gender\":\"male\",\"picture\":\"https://lh5.googleusercontent.com/-5HPa6h3FB88/AAAAAAAAAAI/AAAAAAAAB_4/i0qyKV7fxjg/photo.jpg\",\"link\":\"https://plus.google.com/108349644188900323702\",\"family_name\":\"Aller\",\"given_name\":\"Gonzalo\",\"name\":\"Gonzalo Aller\",\"verified_email\":true,\"email\":\"gonzaller@gmail.com\",\"id\":\"108349644188900323702\"},\"emails\":[{\"value\":\"gonzaller@gmail.com\"}],\"accessToken\":\"ya29.Ci-JA59y1vCARcb5SrKPJsDEx94EHBgxNleqmSBX100uILEO0RGB_RP8LJ18CyxWKA\"}},\"__v\":0,\"dt_update\":\"2016-10-27T23:18:31.741Z\",\"dt_create\":\"2016-10-12T22:33:32.096Z\",\"emailVerified\":true,\"verificationCode\":\"f5f70b492d430bfc262f\",\"profileImg\":\"https://lh5.googleusercontent.com/-5HPa6h3FB88/AAAAAAAAAAI/AAAAAAAAB_4/i0qyKV7fxjg/photo.jpg\",\"id\":\"57feba3ca3b12b294d4891c0\",\"perfil\":{\"_id\":\"57fec0700d63f676601f24ac\",\"sexo\":\"male\",\"nombre\":\"Gonzalo\",\"email\":\"gonzaller@gmail.com\",\"apellido\":\"Aller\",\"owner\":\"57feba3ca3b12b294d4891c0\",\"appId\":\"micupon\",\"cobjectId\":\"usuarios\",\"actions\":{\"comments\":[],\"ratings\":{\"users\":[],\"avg\":0,\"total\":0},\"votes\":{\"users_downvote\":[],\"users_upvote\":[],\"users\":[],\"total\":0}},\"dt_update\":\"2016-10-18T00:44:53.929Z\",\"dt_create\":\"2016-10-12T23:00:00.844Z\",\"__v\":0,\"push_token\":\"62fd3d375167014fbc29a812704fb29a5bd6c0a4d791436dd56a5c7d209e4532\",\"id\":\"57fec0700d63f676601f24ac\"}};\r\n    AccountService.currentUser()\r\n        .then(function(user) {\r\n            if (user || $rootScope.user) {\r\n                $rootScope.user = user ? user : $rootScope.user;\r\n                Stamplay.Object(\"usuarios\").get({owner: $rootScope.user._id})\r\n                    .then(function(res) {\r\n                        $rootScope.user.perfil = res.data[0];\r\n                        vm.buscar();\r\n                    }, function(err) {\r\n                        console.log(err);\r\n                    });\r\n            }else{\r\n                vm.buscar();\r\n            }\r\n        });\r\n\r\n    vm.modalEliminar = $modal({\r\n        scope: $scope,\r\n        template: '<div class=\"modal\"><div class=\"modal-dialog\" role=\"document\"><div class=\"modal-content\"><div class=\"modal-header\"><h4 class=\"modal-title\">Eliminar la banda horaria con id {{ctrl.bandaSeleccionada.id}}?</h4></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" ng-click=\"$hide()\">Cancelar</button><button type=\"button\" class=\"btn btn-danger\" ng-click=\"ctrl.confirmarElim()\">Eliminar</button></div></div></div></div>',\r\n        html: true,\r\n        show: false,\r\n        animation: 'am-slide-top'\r\n    });\r\n\r\n    vm.tableConfig = {\r\n        itemsPerPage: 5,\r\n        fillLastPage: true\r\n    };\r\n\r\n    vm.ingresar = function(i) {\r\n        indexService.login(i);\r\n    };\r\n\r\n    vm.ocultarSide = function() {\r\n        vm.showFiltros = false;\r\n        vm.showNuevo = false;\r\n    };\r\n\r\n    vm.buscar = function() {\r\n        indexService.busqueda(vm.filtros, $rootScope.user).then(function(data) {\r\n            vm.cupones = data;\r\n            vm.showFiltros = false;\r\n            $scope.$digest();\r\n            console.log(data);\r\n        });\r\n    };\r\n\r\n    vm.eliminar = function(item) {\r\n        vm.itemSeleccionado = item;\r\n        vm.modalEliminar.$promise.then(vm.modalEliminar.show);\r\n    };\r\n\r\n    vm.confirmarElim = function() {\r\n        indexService.eliminar(vm.itemSeleccionado).then(function(data) {\r\n            vm.modalEliminar.$promise.then(vm.modalEliminar.hide);\r\n        });\r\n    };\r\n\r\n    vm.guardar = function(item) {\r\n        if(!$rootScope.user){\r\n            $('#login-dialog').modal();\r\n        }\r\n        else{\r\n            indexService.nuevo(item._id,$rootScope.user);\r\n            item.flag = true;\r\n        }\r\n    };\r\n\r\n    vm.limpiarFiltros = function() {\r\n        vm.filtros = {};\r\n    };\r\n    //vm.buscar();\r\n}"]}