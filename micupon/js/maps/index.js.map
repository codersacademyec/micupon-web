{"version":3,"sources":["indexService.js","indexCtrl.js"],"names":["indexService","globalService","socialProvider","login","i","Stamplay","User","socialLogin","getItems","filtro","user","Object","get","then","res","Codeblock","result","err","resCB","updateItem","item","patch","deleteItem","remove","response","saveItem","codeId","usuario","_id","length","codigos","push","notificaciones","data","save","sendPush","perfil","push_token","addAlert","service","busqueda","modificar","eliminar","nuevo","indexCtrl","$scope","$rootScope","AccountService","$modal","vm","this","cupones","showFiltros","showNuevo","filtros","itemSeleccionado","currentUser","owner","buscar","modalEliminar","scope","template","html","show","animation","tableConfig","itemsPerPage","fillLastPage","ingresar","ocultarSide","$apply","$promise","confirmarElim","hide","guardar","$","modal","limpiarFiltros","angular","module","factory","controller"],"mappings":"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","file":"../index.js","sourcesContent":["angular.module('micupon').factory('indexService', ['globalService','socialProvider',indexService]);\r\n\r\nfunction indexService(globalService,socialProvider) {\r\n    var service = {\r\n        busqueda: getItems,\r\n        modificar: updateItem,\r\n        eliminar: deleteItem,\r\n        nuevo: saveItem,\r\n        login: login\r\n    };\r\n\r\n    return service;\r\n    function login(i){\r\n        Stamplay.User.socialLogin(socialProvider[i]);    \r\n    }\r\n    \r\n    function getItems(filtro, user) {  //TODO VER PORQUE CONSULTA PRIMERO Y LUEGO VERIFICA SI EL USER ESTÁ LOGUEADO - HACE QUE NUNCA LLEGUE EL USER Y SE PUEDAN DESHABILITAR LOS CUPONES ENVIADOS\r\n        return Stamplay.Object(\"cupones\").get(filtro)      \r\n            .then(function(res) {\r\n                \r\n                Stamplay.Codeblock(\"cuponespersonas\").get({result: res, user : user}, function(err, resCB) {\r\n                    if(resCB){\r\n                        return resCB;\r\n                    }\r\n                    if(err){\r\n                        //Console.log(err);\r\n                    }\r\n                });\r\n\r\n            }, function(err) {\r\n              //Console.log(err);\r\n            })\r\n    }\r\n\r\n    function updateItem(item){\r\n       Stamplay.Object(\"cupones\").patch(\"codigo\",item)\r\n        .then(function(res) {\r\n          // success\r\n        }, function(err) {\r\n            //Console.log(err);\r\n        }) \r\n    }\r\n\r\n    function deleteItem(item){\r\n       Stamplay.Object(\"cupones\").remove(\"codigo\")\r\n        .then(function(response) {\r\n            // success\r\n        }, function(err) {\r\n          //Console.log(err);\r\n        }) \r\n    }\r\n\r\n    function saveItem(codeId, user){\r\n        Stamplay.Object(\"cupones_usuarios\").get({usuario:user._id}) // buscamos codigos enviados del usuario\r\n        .then(function(response) {\r\n            if(response && response.length > 0){ // si hay registro para el usuario\r\n                response.codigos.push(codeId); // agregamos uno más a la lista de codigos\r\n                Stamplay.Object(\"cupones_usuarios\").patch(response._id,{codigos:response.codigos}) // actualizamos los codigos enviados del usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                   //Console.log(err);\r\n                }) \r\n            }else{\r\n                var data = {usuario:user._id, codigos:[codeId]};\r\n                Stamplay.Object(\"cupones_usuarios\").save(data) // creamos un registro para el usuario en cupones_usuario\r\n                .then(function(res) {\r\n                    notificaciones(user);\r\n                }, function(err) {\r\n                    //Console.log(err);\r\n                }) \r\n            }\r\n        }, function(err) {\r\n            //Console.log(err);\r\n        })      \r\n    }\r\n\r\n    function notificaciones(user){\r\n        globalService.sendPush(user.perfil.push_token,'El cupón ha sido enviado a su movil.'); // enviamos la notificación push\r\n        addAlert(); // mostramos mensaje en pantalla\r\n    }\r\n    \r\n}","angular.module('micupon').controller('indexCtrl', ['$scope', '$rootScope', 'globalService', 'indexService', 'AccountService', '$modal', indexCtrl]);\r\n\r\nfunction indexCtrl($scope, $rootScope, globalService, indexService, AccountService, $modal) {\r\n    var vm = this;\r\n    vm.globalService = globalService;\r\n    vm.cupones = [];\r\n    vm.showFiltros = false;\r\n    vm.showNuevo = false;\r\n    vm.filtros = {};\r\n    vm.nuevo = {};\r\n    vm.itemSeleccionado = {};\r\n \r\n\r\n    AccountService.currentUser()\r\n        .then(function(user) {\r\n            if (user || $rootScope.user) {\r\n                $rootScope.user = user ? user : $rootScope.user;\r\n                Stamplay.Object(\"usuarios\").get({owner: $rootScope.user._id})\r\n                    .then(function(res) {\r\n                        $rootScope.user.perfil = res.data[0];\r\n                    }, function(err) {\r\n                        //Console.log(err);\r\n                    })\r\n            }\r\n\t\t\tvm.buscar();       \r\n        });\r\n\r\n    vm.modalEliminar = $modal({\r\n        scope: $scope,\r\n        template: '<div class=\"modal\"><div class=\"modal-dialog\" role=\"document\"><div class=\"modal-content\"><div class=\"modal-header\"><h4 class=\"modal-title\">Eliminar la banda horaria con id {{ctrl.bandaSeleccionada.id}}?</h4></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" ng-click=\"$hide()\">Cancelar</button><button type=\"button\" class=\"btn btn-danger\" ng-click=\"ctrl.confirmarElim()\">Eliminar</button></div></div></div></div>',\r\n        html: true,\r\n        show: false,\r\n        animation: 'am-slide-top'\r\n    });\r\n\r\n    vm.tableConfig = {\r\n        itemsPerPage: 5,\r\n        fillLastPage: true\r\n    };\r\n\r\n    vm.ingresar = function(i) {\r\n        indexService.login(i);\r\n    };\r\n\r\n    vm.ocultarSide = function() {\r\n        vm.showFiltros = false;\r\n        vm.showNuevo = false;\r\n    };\r\n\r\n    vm.buscar = function() {\r\n        indexService.busqueda(vm.filtros, $rootScope.user).then(function(data) {\r\n            vm.cupones = data;\r\n            vm.showFiltros = false;\r\n            $scope.$apply();\r\n        });\r\n    };\r\n\r\n    vm.eliminar = function(item) {\r\n        vm.itemSeleccionado = item;\r\n        vm.modalEliminar.$promise.then(vm.modalEliminar.show);\r\n    };\r\n\r\n    vm.confirmarElim = function() {\r\n        indexService.eliminar(vm.itemSeleccionado).then(function(data) {\r\n            vm.modalEliminar.$promise.then(vm.modalEliminar.hide);\r\n        });\r\n    };\r\n\r\n    vm.guardar = function(item) {\r\n        if(!$rootScope.user){\r\n            $('#login-dialog').modal();\r\n        }\r\n        else{\r\n            indexService.nuevo(item,$rootScope.user);\r\n        }\r\n    };\r\n\r\n    vm.limpiarFiltros = function() {\r\n        vm.filtros = {};\r\n    };\r\n    \r\n}"]}